<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –æ—Ç—á–µ—Ç EcoWatt</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; color: #333; max-width: 210mm; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #2c3e50; padding-bottom: 20px; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .client-info { text-align: right; }
        
        h2 { color: #2980b9; margin-top: 30px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: #f0f2f5; padding: 10px; text-align: left; font-weight: 600; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        
        .summary-box { background: #eaf2f8; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-around; }
        .sum-item { text-align: center; }
        .sum-val { display: block; font-size: 18px; font-weight: bold; color: #2c3e50; }
        .sum-lbl { font-size: 12px; color: #7f8c8d; text-transform: uppercase; }

        .no-data { color: #999; font-style: italic; padding: 10px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
        @media print {
            body { padding: 0; margin: 0; }
            .no-print { display: none; }
            a { text-decoration: none; color: #333; }
        }
        
        .btn-print {
            position: fixed; top: 20px; right: 20px;
            background: #e74c3c; color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const tg = window.Telegram.WebApp;
    
    // –°–æ–æ–±—â–∞–µ–º —Ç–µ–ª–µ–≥—Ä–∞–º—É, —á—Ç–æ –º—ã –≥–æ—Ç–æ–≤—ã
    tg.ready();
    
    // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω (–≤–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–æ–∫)
    tg.expand();

    // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ–Ω –ø–æ–¥ —Ç–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // document.body.style.backgroundColor = tg.themeParams.bg_color || "#f0f2f5";
</script>
</head>
<body>

    <button class="btn-print no-print" onclick="window.print()">üñ® –ü–µ—á–∞—Ç—å / PDF</button>

    <div class="header">
        <div class="logo">EcoWatt <span style="color:#2980b9">Engineering</span></div>
        <div class="client-info">
            <div id="report-client-name" style="font-weight:bold; font-size:1.2em;">–ö–ª–∏–µ–Ω—Ç</div>
            <div id="report-date" style="color:#666; font-size:0.9em;">–î–∞—Ç–∞</div>
        </div>
    </div>

    <h1>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –°–≠–°</h1>

    <div id="section-audit">
        <h2>1. –ê—É–¥–∏—Ç –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è</h2>
        <table id="table-audit">
            <thead>
                <tr>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–ú–æ—â–Ω–æ—Å—Ç—å</th>
                    <th>–ö–æ–ª-–≤–æ</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–≠–Ω–µ—Ä–≥–∏—è (—Å—É—Ç–∫–∏)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        
        <div class="summary-box" id="audit-summary">
            </div>
    </div>

    <div id="section-battery" style="margin-top: 30px;">
        <h2>2. –†–∞—Å—á–µ—Ç –ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç–∏ (–ê–ö–ë)</h2>
        <div id="bat-content" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
    </div>

    <div id="section-cable" style="margin-top: 30px;">
        <h2>3. –ö–∞–±–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏</h2>
        <div id="cable-content" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
    </div>

    <script src="project-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const project = ProjectManager.getActiveProject();
            
            // –®–∞–ø–∫–∞
            document.getElementById('report-client-name').textContent = project.name;
            document.getElementById('report-date').textContent = new Date().toLocaleDateString();

            // 1. –†–µ–Ω–¥–µ—Ä –ê–£–î–ò–¢–ê
            const auditData = project.data.audit;
            if (auditData && auditData.rows && auditData.rows.length > 0) {
                const tbody = document.querySelector('#table-audit tbody');
                
                auditData.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    const energy = Math.round(row.power * row.qty * row.time);
                    tr.innerHTML = `
                        <td>${row.name}</td>
                        <td>${row.power} –í—Ç</td>
                        <td>${row.qty}</td>
                        <td>${row.time} —á</td>
                        <td>${energy} –í—Ç¬∑—á</td>
                    `;
                    tbody.appendChild(tr);
                });
				// --- 2. –†–µ–Ω–¥–µ—Ä –ê–ö–ë ---
            const batData = project.data.battery;
            if (batData && batData.result_main) {
                const box = document.getElementById('bat-content');
                box.className = ''; // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å no-data
                
                let info = "";
                if(batData.mode == "1") {
                    info = `–ü—Ä–∏ –µ–º–∫–æ—Å—Ç–∏ –ê–ö–ë <b>${batData.capacity} Ah</b> (${batData.type}) –∏ –Ω–∞–≥—Ä—É–∑–∫–µ <b>${batData.load} –í—Ç</b>`;
                } else {
                    info = `–î–ª—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã <b>${batData.target_time} —á</b> –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ <b>${batData.load} –í—Ç</b>`;
                }

                box.innerHTML = `
                    <div style="background:#eafaf1; padding:15px; border-left:4px solid #27ae60;">
                        <div style="margin-bottom:5px;">${info}</div>
                        <div style="font-size:1.4em; font-weight:bold; color:#27ae60;">${batData.result_main}</div>
                        <div style="color:#666; font-size:0.9em;">${batData.result_sub}</div>
                    </div>
                `;
            }

            // --- 3. –†–µ–Ω–¥–µ—Ä –ö–∞–±–µ–ª—è ---
            const cableData = project.data.cable;
            if (cableData && cableData.cable_size) {
                const box = document.getElementById('cable-content');
                box.className = '';
                
                box.innerHTML = `
                    <table style="width:100%">
                        <tr>
                            <td>–°–∏—Å—Ç–µ–º–∞: <b>${cableData.voltage}–í</b></td>
                            <td>–ú–æ—â–Ω–æ—Å—Ç—å/–¢–æ–∫: <b>${cableData.power}</b></td>
                            <td>–î–ª–∏–Ω–∞: <b>${cableData.dist} –º</b></td>
                        </tr>
                    </table>
                    <div style="display:flex; gap:20px; margin-top:10px;">
                        <div style="flex:1; background:#fff8e1; padding:10px; border:1px solid #ffe0b2; text-align:center;">
                            <div style="font-size:0.8em; color:#e67e22;">–°–ï–ß–ï–ù–ò–ï</div>
                            <div style="font-size:1.2em; font-weight:bold;">${cableData.cable_size}</div>
                        </div>
                        <div style="flex:1; background:#f0f0f0; padding:10px; border:1px solid #ddd; text-align:center;">
                            <div style="font-size:0.8em; color:#666;">–ó–ê–©–ò–¢–ê</div>
                            <div style="font-size:1.2em; font-weight:bold;">${cableData.fuse}</div>
                        </div>
                         <div style="flex:1; background:#f0f0f0; padding:10px; border:1px solid #ddd; text-align:center;">
                            <div style="font-size:0.8em; color:#666;">–ü–û–¢–ï–†–ò</div>
                            <div style="font-size:1.2em; font-weight:bold;">${cableData.loss}</div>
                        </div>
                    </div>
                `;
            }

                // –ò—Ç–æ–≥–∏
                if (auditData.summary) {
                    const box = document.getElementById('audit-summary');
                    box.innerHTML = `
                        <div class="sum-item">
                            <span class="sum-val">${auditData.summary.inv}</span>
                            <span class="sum-lbl">–ò–Ω–≤–µ—Ä—Ç–æ—Ä</span>
                        </div>
                        <div class="sum-item">
                            <span class="sum-val">${auditData.summary.energy}</span>
                            <span class="sum-lbl">–≠–Ω–µ—Ä–≥–∏—è/–°—É—Ç–∫–∏</span>
                        </div>
                    `;
                }
            } else {
                document.getElementById('section-audit').innerHTML += '<div class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞—É–¥–∏—Ç–∞.</div>';
            }

            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏ –¥–ª—è –ê–ö–ë –∏ –ö–∞–±–µ–ª—è –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏...
        });
    </script>
</body>
</html>